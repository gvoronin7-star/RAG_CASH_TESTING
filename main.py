"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ RAG-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

–≠—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–∫–µ—à, –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞, RAG)
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
4. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª –æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
"""

import os
from dotenv import load_dotenv
from embeddings import EmbeddingStore, get_sample_documents
from rag import RAGAssistant
from cache import ResponseCache


def initialize_system():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã RAG-—Å–∏—Å—Ç–µ–º—ã.
    
    Returns:
        –ö–æ—Ä—Ç–µ–∂ (embedding_store, rag_assistant, cache)
    """
    print("=" * 70)
    print("üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø RAG-–ê–°–°–ò–°–¢–ï–ù–¢–ê")
    print("=" * 70)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
    load_dotenv()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞ OpenAI
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –Ω–∞–π–¥–µ–Ω OPENAI_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
        print("   –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç—É–¥–∞: OPENAI_API_KEY=your_key_here")
        print("   –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ.")
        print()
    
    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–µ—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
    print("\n[1/3] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–µ—à–∞...")
    cache = ResponseCache(cache_file="cache.json")
    
    # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ChromaDB
    print("\n[2/3] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞...")
    embedding_store = EmbeddingStore(
        collection_name="rag_documents",
        persist_directory="./chroma_db",
        embedding_model="text-embedding-3-small",  # –ú–æ–¥–µ–ª—å OpenAI –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
        api_key=api_key
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if embedding_store.collection.count() == 0:
        print("\nüìù –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞. –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...")
        sample_docs = get_sample_documents()
        embedding_store.add_documents(sample_docs)
    else:
        print(f"‚úì –í –±–∞–∑–µ —É–∂–µ –µ—Å—Ç—å {embedding_store.collection.count()} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    
    # 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º RAG-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    print("\n[3/3] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞...")
    rag_assistant = RAGAssistant(
        embedding_store=embedding_store,
        model="gpt-3.5-turbo",
        temperature=0.7
    )
    
    print("\n" + "=" * 70)
    print("‚úÖ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï")
    print("=" * 70)
    
    return embedding_store, rag_assistant, cache


def answer_question(query: str, rag_assistant: RAGAssistant, cache: ResponseCache) -> str:
    """
    –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–µ—à–∞ –∏ RAG.
    
    –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à - –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –µ—Å—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ–º RAG (–ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
    3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ –∫–µ—à
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
    
    Args:
        query: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        rag_assistant: –≠–∫–∑–µ–º–ø–ª—è—Ä RAG-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        cache: –≠–∫–∑–µ–º–ø–ª—è—Ä –∫–µ—à–∞
        
    Returns:
        –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
    """
    print("\n" + "=" * 70)
    print(f"‚ùì –í–û–ü–†–û–°: {query}")
    print("=" * 70)
    
    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
    print("\n[–®–∞–≥ 1] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞...")
    cached_answer = cache.get(query)
    
    if cached_answer:
        # –û—Ç–≤–µ—Ç –Ω–∞–π–¥–µ–Ω –≤ –∫–µ—à–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
        print("\nüíæ –û—Ç–≤–µ—Ç –∏–∑ –∫–µ—à–∞:")
        print("-" * 70)
        print(cached_answer)
        print("-" * 70)
        return cached_answer
    
    # –®–∞–≥ 2: –û—Ç–≤–µ—Ç–∞ –Ω–µ—Ç –≤ –∫–µ—à–µ - –≤—ã–ø–æ–ª–Ω—è–µ–º RAG
    print("\n[–®–∞–≥ 2] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ RAG (–ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)...")
    
    try:
        answer, search_results = rag_assistant.generate_response(
            query=query,
            top_k=3,
            verbose=True
        )
        
        # –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∫–µ—à
        print("\n[–®–∞–≥ 3] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –∫–µ—à...")
        cache.set(query, answer)
        
        # –í—ã–≤–æ–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        print("\nüí° –û–¢–í–ï–¢:")
        print("-" * 70)
        print(answer)
        print("-" * 70)
        
        return answer
        
    except Exception as e:
        error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}"
        print(f"\n‚ùå {error_msg}")
        return error_msg


def interactive_mode(rag_assistant: RAGAssistant, cache: ResponseCache):
    """
    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.
    
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ —Ü–∏–∫–ª–µ –¥–æ —Ç–µ—Ö –ø–æ—Ä,
    –ø–æ–∫–∞ –Ω–µ –≤–≤–µ–¥–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤—ã—Ö–æ–¥–∞.
    """
    print("\n" + "=" * 70)
    print("üí¨ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú")
    print("=" * 70)
    print("\n–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É.")
    print("–î–ª—è –≤—ã—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ: exit, quit, –≤—ã—Ö–æ–¥ –∏–ª–∏ q")
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
    print("  ‚Ä¢ cache - –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–µ—à–µ")
    print("  ‚Ä¢ clear_cache - –æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à")
    print("  ‚Ä¢ stats - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã")
    print()
    
    while True:
        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_input = input("\nüë§ –í—ã: ").strip()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤—ã—Ö–æ–¥–∞
            if user_input.lower() in ['exit', 'quit', '–≤—ã—Ö–æ–¥', 'q', '']:
                print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            if user_input.lower() == 'cache':
                print(f"\nüìä –ö–µ—à —Å–æ–¥–µ—Ä–∂–∏—Ç {cache.size()} –∑–∞–ø–∏—Å–µ–π")
                continue
            
            if user_input.lower() == 'clear_cache':
                cache.clear()
                print("\n‚úì –ö–µ—à –æ—á–∏—â–µ–Ω")
                continue
            
            if user_input.lower() == 'stats':
                print(f"\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´:")
                print(f"  ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ ChromaDB: {rag_assistant.embedding_store.collection.count()}")
                print(f"  ‚Ä¢ –ó–∞–ø–∏—Å–µ–π –≤ –∫–µ—à–µ: {cache.size()}")
                print(f"  ‚Ä¢ –ú–æ–¥–µ–ª—å LLM: {rag_assistant.model}")
                continue
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            answer_question(user_input, rag_assistant, cache)
            
        except KeyboardInterrupt:
            print("\n\nüëã –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break
        except Exception as e:
            print(f"\n‚ùå –û—à–∏–±–∫–∞: {str(e)}")


def demo_mode(rag_assistant: RAGAssistant, cache: ResponseCache):
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Å –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö, –≤–∫–ª—é—á–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞.
    """
    print("\n" + "=" * 70)
    print("üé¨ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–û–ù–ù–´–ô –†–ï–ñ–ò–ú")
    print("=" * 70)
    print("\n–°–µ–π—á–∞—Å –±—É–¥–µ—Ç –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ RAG-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞")
    print("–Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.\n")
    
    # –°–ø–∏—Å–æ–∫ –¥–µ–º–æ-–≤–æ–ø—Ä–æ—Å–æ–≤
    demo_questions = [
        "–ß—Ç–æ —Ç–∞–∫–æ–µ Python –∏ –¥–ª—è —á–µ–≥–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?",
        "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ RAG –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–ß—Ç–æ —Ç–∞–∫–æ–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?",
        "–ß—Ç–æ —Ç–∞–∫–æ–µ Python –∏ –¥–ª—è —á–µ–≥–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?"  # –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∫–µ—à–∞
    ]
    
    for i, question in enumerate(demo_questions, 1):
        print(f"\n\n{'#' * 70}")
        print(f"–í–û–ü–†–û–° {i} –∏–∑ {len(demo_questions)}")
        print(f"{'#' * 70}")
        
        answer_question(question, rag_assistant, cache)
        
        # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ)
        if i < len(demo_questions):
            input("\n[–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞...]")
    
    print("\n\n" + "=" * 70)
    print("‚úÖ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
    print("=" * 70)


def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
        embedding_store, rag_assistant, cache = initialize_system()
        
        # –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
        print("\n" + "=" * 70)
        print("–í–´–ë–û–† –†–ï–ñ–ò–ú–ê –†–ê–ë–û–¢–´")
        print("=" * 70)
        print("\n1. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º - –∑–∞–¥–∞–≤–∞–π—Ç–µ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã")
        print("2. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º - –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤")
        print()
        
        mode = input("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º (1 –∏–ª–∏ 2, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1): ").strip()
        
        if mode == '2':
            demo_mode(rag_assistant, cache)
            
            # –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
            print("\n" + "=" * 70)
            continue_interactive = input("\n–ü–µ—Ä–µ–π—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º? (y/n): ").strip().lower()
            if continue_interactive in ['y', 'yes', '–¥', '–¥–∞', '']:
                interactive_mode(rag_assistant, cache)
        else:
            interactive_mode(rag_assistant, cache)
        
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()

