"""
РњРѕРґСѓР»СЊ РґР»СЏ РєРµС€РёСЂРѕРІР°РЅРёСЏ РѕС‚РІРµС‚РѕРІ LLM.

РљРµС€ РїРѕР·РІРѕР»СЏРµС‚ РёР·Р±РµР¶Р°С‚СЊ РїРѕРІС‚РѕСЂРЅС‹С… Р·Р°РїСЂРѕСЃРѕРІ Рє LLM РґР»СЏ РѕРґРёРЅР°РєРѕРІС‹С… РІРѕРїСЂРѕСЃРѕРІ,
С‡С‚Рѕ СЌРєРѕРЅРѕРјРёС‚ РІСЂРµРјСЏ Рё РґРµРЅСЊРіРё РЅР° API-Р·Р°РїСЂРѕСЃС‹.
"""

import hashlib
import json
from typing import Optional
from pathlib import Path


class ResponseCache:
    """
    РџСЂРѕСЃС‚РѕР№ РєРµС€ РґР»СЏ С…СЂР°РЅРµРЅРёСЏ РѕС‚РІРµС‚РѕРІ LLM.
    
    РСЃРїРѕР»СЊР·СѓРµС‚ СЃР»РѕРІР°СЂСЊ Python РґР»СЏ С…СЂР°РЅРµРЅРёСЏ РїР°СЂ (С…РµС€_Р·Р°РїСЂРѕСЃР°, РѕС‚РІРµС‚).
    РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РєРµС€ РјРѕР¶РЅРѕ СЃРѕС…СЂР°РЅРёС‚СЊ РІ С„Р°Р№Р» Рё Р·Р°РіСЂСѓР·РёС‚СЊ РѕР±СЂР°С‚РЅРѕ.
    """
    
    def __init__(self, cache_file: str = "cache.json"):
        """
        РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ РєРµС€Р°.
        
        Args:
            cache_file: РџСѓС‚СЊ Рє С„Р°Р№Р»Сѓ РґР»СЏ СЃРѕС…СЂР°РЅРµРЅРёСЏ РєРµС€Р° РЅР° РґРёСЃРє
        """
        self.cache_file = Path(cache_file)
        self.cache = {}
        
        # Р—Р°РіСЂСѓР¶Р°РµРј СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёР№ РєРµС€, РµСЃР»Рё С„Р°Р№Р» РµСЃС‚СЊ
        self._load_cache()
    
    def _get_cache_key(self, query: str) -> str:
        """
        РЎРѕР·РґР°РµС‚ СѓРЅРёРєР°Р»СЊРЅС‹Р№ РєР»СЋС‡ (С…РµС€) РґР»СЏ Р·Р°РїСЂРѕСЃР°.
        
        РСЃРїРѕР»СЊР·СѓРµРј SHA-256 РґР»СЏ СЃРѕР·РґР°РЅРёСЏ СЃС‚Р°Р±РёР»СЊРЅРѕРіРѕ С…РµС€Р° С‚РµРєСЃС‚Р°.
        РћРґРёРЅР°РєРѕРІС‹Рµ Р·Р°РїСЂРѕСЃС‹ РІСЃРµРіРґР° РґР°РґСѓС‚ РѕРґРёРЅР°РєРѕРІС‹Р№ РєР»СЋС‡.
        
        Args:
            query: РџРѕР»СЊР·РѕРІР°С‚РµР»СЊСЃРєРёР№ Р·Р°РїСЂРѕСЃ
            
        Returns:
            РҐРµС€-СЃС‚СЂРѕРєР° РґР»СЏ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ РєР°Рє РєР»СЋС‡ РєРµС€Р°
        """
        # РќРѕСЂРјР°Р»РёР·СѓРµРј Р·Р°РїСЂРѕСЃ: СѓР±РёСЂР°РµРј Р»РёС€РЅРёРµ РїСЂРѕР±РµР»С‹ Рё РїСЂРёРІРѕРґРёРј Рє РЅРёР¶РЅРµРјСѓ СЂРµРіРёСЃС‚СЂСѓ
        normalized_query = " ".join(query.lower().split())
        
        # РЎРѕР·РґР°РµРј SHA-256 С…РµС€
        return hashlib.sha256(normalized_query.encode('utf-8')).hexdigest()
    
    def get(self, query: str) -> Optional[str]:
        """
        РџРѕР»СѓС‡Р°РµС‚ РѕС‚РІРµС‚ РёР· РєРµС€Р°, РµСЃР»Рё РѕРЅ РµСЃС‚СЊ.
        
        Args:
            query: РџРѕР»СЊР·РѕРІР°С‚РµР»СЊСЃРєРёР№ Р·Р°РїСЂРѕСЃ
            
        Returns:
            Р—Р°РєРµС€РёСЂРѕРІР°РЅРЅС‹Р№ РѕС‚РІРµС‚ РёР»Рё None, РµСЃР»Рё РѕС‚РІРµС‚Р° РЅРµС‚ РІ РєРµС€Рµ
        """
        cache_key = self._get_cache_key(query)
        
        if cache_key in self.cache:
            print(f"вњ“ РќР°Р№РґРµРЅ РѕС‚РІРµС‚ РІ РєРµС€Рµ РґР»СЏ Р·Р°РїСЂРѕСЃР°: '{query[:50]}...'")
            return self.cache[cache_key]
        
        print(f"вњ— РћС‚РІРµС‚ РЅРµ РЅР°Р№РґРµРЅ РІ РєРµС€Рµ, РІС‹РїРѕР»РЅСЏРµРј RAG РїРѕРёСЃРє...")
        return None
    
    def set(self, query: str, response: str) -> None:
        """
        РЎРѕС…СЂР°РЅСЏРµС‚ РѕС‚РІРµС‚ РІ РєРµС€.
        
        Args:
            query: РџРѕР»СЊР·РѕРІР°С‚РµР»СЊСЃРєРёР№ Р·Р°РїСЂРѕСЃ
            response: РћС‚РІРµС‚ РѕС‚ LLM
        """
        cache_key = self._get_cache_key(query)
        self.cache[cache_key] = response
        
        # РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРё СЃРѕС…СЂР°РЅСЏРµРј РєРµС€ РЅР° РґРёСЃРє РїРѕСЃР»Рµ РєР°Р¶РґРѕРіРѕ РґРѕР±Р°РІР»РµРЅРёСЏ
        self._save_cache()
        
        print(f"вњ“ РћС‚РІРµС‚ СЃРѕС…СЂР°РЅРµРЅ РІ РєРµС€Рµ")
    
    def _save_cache(self) -> None:
        """
        РЎРѕС…СЂР°РЅСЏРµС‚ РєРµС€ РІ JSON С„Р°Р№Р».
        
        Р­С‚Рѕ РїРѕР·РІРѕР»СЏРµС‚ СЃРѕС…СЂР°РЅРёС‚СЊ РєРµС€ РјРµР¶РґСѓ Р·Р°РїСѓСЃРєР°РјРё РїСЂРѕРіСЂР°РјРјС‹.
        """
        try:
            with open(self.cache_file, 'w', encoding='utf-8') as f:
                json.dump(self.cache, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"вљ  РџСЂРµРґСѓРїСЂРµР¶РґРµРЅРёРµ: РЅРµ СѓРґР°Р»РѕСЃСЊ СЃРѕС…СЂР°РЅРёС‚СЊ РєРµС€: {e}")
    
    def _load_cache(self) -> None:
        """
        Р—Р°РіСЂСѓР¶Р°РµС‚ РєРµС€ РёР· JSON С„Р°Р№Р»Р°, РµСЃР»Рё РѕРЅ СЃСѓС‰РµСЃС‚РІСѓРµС‚.
        """
        if self.cache_file.exists():
            try:
                with open(self.cache_file, 'r', encoding='utf-8') as f:
                    self.cache = json.load(f)
                print(f"вњ“ Р—Р°РіСЂСѓР¶РµРЅ РєРµС€ СЃ {len(self.cache)} Р·Р°РїРёСЃСЏРјРё")
            except Exception as e:
                print(f"вљ  РџСЂРµРґСѓРїСЂРµР¶РґРµРЅРёРµ: РЅРµ СѓРґР°Р»РѕСЃСЊ Р·Р°РіСЂСѓР·РёС‚СЊ РєРµС€: {e}")
                self.cache = {}
    
    def clear(self) -> None:
        """
        РћС‡РёС‰Р°РµС‚ РІРµСЃСЊ РєРµС€.
        """
        self.cache = {}
        if self.cache_file.exists():
            self.cache_file.unlink()
        print("вњ“ РљРµС€ РѕС‡РёС‰РµРЅ")
    
    def size(self) -> int:
        """
        Р’РѕР·РІСЂР°С‰Р°РµС‚ РєРѕР»РёС‡РµСЃС‚РІРѕ Р·Р°РїРёСЃРµР№ РІ РєРµС€Рµ.
        """
        return len(self.cache)


